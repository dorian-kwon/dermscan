<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DermScan 관리자 - 피드백 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .content-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        .stats-container {
            margin-bottom: 30px;
        }
        .stats-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .stats-card-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .stats-card-positive {
            color: #28a745;
        }
        .stats-card-negative {
            color: #dc3545;
        }
        .feedback-image {
            max-width: 100px;
            max-height: 100px;
            border-radius: 5px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .filter-container {
            margin-bottom: 20px;
        }
        .score-positive {
            color: green;
            font-weight: bold;
        }
        .score-negative {
            color: red;
            font-weight: bold;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DermScan 관리자</h1>
            <p class="lead">데이터 관리</p>
        </div>
        
        <!-- 네비게이션 탭 -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback-content" type="button" role="tab" aria-controls="feedback-content" aria-selected="true">피드백 관리</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log-content" type="button" role="tab" aria-controls="log-content" aria-selected="false">분석 로그</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="feedback-content" role="tabpanel" aria-labelledby="feedback-tab">

        <!-- 통계 섹션 -->
        <div class="content-container stats-container">
            <h2 class="mb-4">피드백 통계</h2>
            <div class="row">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>총 피드백 수</h5>
                        <div class="stats-card-value" id="total-feedback">0</div>
                        <p>전체 수집된 피드백</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>좋아요</h5>
                        <div class="stats-card-value stats-card-positive" id="total-likes">0</div>
                        <p>긍정적인 피드백</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>싫어요</h5>
                        <div class="stats-card-value stats-card-negative" id="total-dislikes">0</div>
                        <p>부정적인 피드백</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-container">
            <div class="filter-container">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">날짜 범위</span>
                            <input type="date" class="form-control" id="start-date">
                            <input type="date" class="form-control" id="end-date">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="score-filter">
                            <option value="all">모든 점수</option>
                            <option value="positive">좋아요 (1)</option>
                            <option value="negative">싫어요 (-1)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="model">
                            <option value="" selected>전체</option>
                            <option value="vi" >Vision Transformer 모델</option>
                            <option value="swin">Swin Transformer 모델</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="filter-btn">필터 적용</button>
                    </div>
                </div>
            </div>

            <h2 class="mb-4">피드백 목록</h2>
            <div class="mb-3">
                <button class="btn btn-danger" id="delete-selected-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    선택 항목 삭제
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                            </th>
                            <th>ID</th>
                            <th>모델</th>
                            <th>이미지</th>
                            <th>IP 주소</th>
                            <th>점수</th>
                            <th>진단 정보</th>
                            <th>날짜 및 시간</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="feedback-table">
                        <!-- 피드백 데이터가 여기에 동적으로 로드됩니다 -->
                    </tbody>
                </table>
            </div>

            <div id="pagination" class="pagination-container">
                <!-- 페이지네이션이 여기에 동적으로 로드됩니다 -->
            </div>
        </div>
            </div>
            
            <!-- 분석 로그 탭 내용 -->
            <div class="tab-pane fade" id="log-content" role="tabpanel" aria-labelledby="log-tab">
                <!-- 통계 섹션 -->
                <div class="content-container stats-container">
                    <h2 class="mb-4">분석 로그 통계</h2>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h5>총 분석 횟수</h5>
                                <div class="stats-card-value" id="total-logs">0</div>
                                <p>전체 분석 로그</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h5>Vision Transformer</h5>
                                <div class="stats-card-value" id="vi-logs">0</div>
                                <p>Vision Transformer 모델 사용</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card">
                                <h5>Swin Transformer</h5>
                                <div class="stats-card-value" id="swin-logs">0</div>
                                <p>Swin Transformer 모델 사용</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-container">
                    <div class="filter-container">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">날짜 범위</span>
                                    <input type="date" class="form-control" id="log-start-date">
                                    <input type="date" class="form-control" id="log-end-date">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="log-model">
                                    <option value="" selected>전체</option>
                                    <option value="vi" >Vision Transformer 모델</option>
                                    <option value="swin">Swin Transformer 모델</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" id="log-filter-btn">필터 적용</button>
                            </div>
                        </div>
                    </div>

                    <h2 class="mb-4">분석 로그 목록</h2>
                    <div class="mb-3">
                        <button class="btn btn-danger" id="log-delete-selected-btn" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            선택 항목 삭제
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="log-select-all-checkbox" class="form-check-input">
                                    </th>
                                    <th>ID</th>
                                    <th>모델</th>
                                    <th>이미지</th>
                                    <th>IP 주소</th>
                                    <th>진단 정보</th>
                                    <th>날짜 및 시간</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="log-table">
                                <!-- 분석 로그 데이터가 여기에 동적으로 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>

                    <div id="log-pagination" class="pagination-container">
                        <!-- 페이지네이션이 여기에 동적으로 로드됩니다 -->
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2025 DermScan 관리자 페이지</p>
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">이미지 상세 보기</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" class="modal-image" alt="확대된 이미지">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 이미지를 모달에 표시하는 함수
        function showImageInModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 피드백 관련 요소
            const feedbackTable = document.getElementById('feedback-table');
            const paginationContainer = document.getElementById('pagination');
            const filterBtn = document.getElementById('filter-btn');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const scoreFilter = document.getElementById('score-filter');
            const ipSearch = document.getElementById('ip-search');
            const modelSelect = document.getElementById('model');
            
            // 분석 로그 관련 요소
            const logTable = document.getElementById('log-table');
            const logPaginationContainer = document.getElementById('log-pagination');
            const logFilterBtn = document.getElementById('log-filter-btn');
            const logStartDateInput = document.getElementById('log-start-date');
            const logEndDateInput = document.getElementById('log-end-date');
            const logModelSelect = document.getElementById('log-model');
            
            // 피드백 삭제 관련 요소
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            
            // 로그 삭제 관련 요소
            const logSelectAllCheckbox = document.getElementById('log-select-all-checkbox');
            const logDeleteSelectedBtn = document.getElementById('log-delete-selected-btn');
            
            // 피드백 통계 요소
            const totalFeedbackEl = document.getElementById('total-feedback');
            const totalLikesEl = document.getElementById('total-likes');
            const totalDislikesEl = document.getElementById('total-dislikes');
            
            // 로그 통계 요소
            const totalLogsEl = document.getElementById('total-logs');
            const viLogsEl = document.getElementById('vi-logs');
            const swinLogsEl = document.getElementById('swin-logs');
            
            // 현재 피드백 페이지
            let currentFeedbackPage = 1;
            // 현재 로그 페이지
            let currentLogPage = 1;
            // 페이지당 항목 수
            const itemsPerPage = 10;
            
            // 피드백 체크박스 상태 업데이트 함수
            function updateFeedbackSelectedState() {
                const checkboxes = document.querySelectorAll('.feedback-checkbox');
                const selectedCount = document.querySelectorAll('.feedback-checkbox:checked').length;
                
                // 모두 선택 체크박스 상태 업데이트
                if (checkboxes.length > 0 && selectedCount === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCount > 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
                
                // 삭제 버튼 상태 업데이트
                deleteSelectedBtn.disabled = selectedCount === 0;
            }
            
            // 모두 선택 체크박스 이벤트
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.feedback-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                
                updateFeedbackSelectedState();
            });
            
            // 테이블 이벤트 위임 (체크박스 변경 및 삭제 버튼 클릭)
            feedbackTable.addEventListener('change', function(e) {
                if (e.target.classList.contains('feedback-checkbox')) {
                    updateFeedbackSelectedState();
                }
            });
            
            feedbackTable.addEventListener('click', function(e) {
                if (e.target.closest('.delete-btn')) {
                    const button = e.target.closest('.delete-btn');
                    const id = button.getAttribute('data-id');
                    
                    if (confirm('정말로 이 피드백을 삭제하시겠습니까?')) {
                        deleteFeedback([id]);
                    }
                }
            });
            
            // 선택 항목 삭제 버튼 이벤트
            deleteSelectedBtn.addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('.feedback-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(checkbox => 
                    checkbox.getAttribute('data-id')
                );
                
                if (selectedIds.length === 0) {
                    alert('삭제할 항목을 선택해주세요.');
                    return;
                }
                
                if (confirm(`선택한 ${selectedIds.length}개 항목을 삭제하시겠습니까?`)) {
                    deleteFeedback(selectedIds);
                }
            });
            
            // 피드백 삭제 함수
            function deleteFeedback(ids) {
                fetch('/api/admin/feedback/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ids: ids })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    // 성공 메시지 표시
                    alert(`${ids.length}개 항목이 삭제되었습니다.`);
                    
                    // 데이터 다시 로드
                    loadFeedbackData();
                    loadFeedbackStatistics();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
            
            // 초기 날짜 설정 (7일 전 ~ 오늘)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            startDateInput.valueAsDate = sevenDaysAgo;
            endDateInput.valueAsDate = today;
            logStartDateInput.valueAsDate = sevenDaysAgo;
            logEndDateInput.valueAsDate = today;
            
            // 피드백 필터 적용 클릭 이벤트
            filterBtn.addEventListener('click', function() {
                currentFeedbackPage = 1;
                loadFeedbackData();
                loadFeedbackStatistics();
            });
            
            // 로그 필터 적용 클릭 이벤트
            logFilterBtn.addEventListener('click', function() {
                currentLogPage = 1;
                loadLogData();
                loadLogStatistics();
            });
            
            // 탭 변경 이벤트 리스너
            document.getElementById('feedback-tab').addEventListener('shown.bs.tab', function (e) {
                if (feedbackTable.innerHTML.trim() === '') {
                    loadFeedbackData();
                    loadFeedbackStatistics();
                }
            });
            
            document.getElementById('log-tab').addEventListener('shown.bs.tab', function (e) {
                if (logTable.innerHTML.trim() === '') {
                    loadLogData();
                    loadLogStatistics();
                }
            });
            
            // 초기 피드백 데이터 로드 (첫 페이지 로드 시)
            loadFeedbackData();
            loadFeedbackStatistics();
            
            // 피드백 통계 데이터 로드 함수
            function loadFeedbackStatistics() {
                // 필터 옵션
                const filters = {
                    start_date: startDateInput.value,
                    end_date: endDateInput.value,
                    model: modelSelect.value,
                };
                
                // API 요청
                fetch(`/api/admin/statistics?${new URLSearchParams(filters)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('서버 응답 오류');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 통계 데이터 표시
                        totalFeedbackEl.textContent = data.total_feedback;
                        totalLikesEl.textContent = data.total_likes;
                        totalDislikesEl.textContent = data.total_dislikes;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // 오류 시 0으로 표시
                        totalFeedbackEl.textContent = '0';
                        totalLikesEl.textContent = '0';
                        totalDislikesEl.textContent = '0';
                    });
            }
            
            // 피드백 데이터 로드 함수
            function loadFeedbackData() {
                // 필터 옵션
                const filters = {
                    start_date: startDateInput.value,
                    end_date: endDateInput.value,
                    score: scoreFilter.value,
                    model: modelSelect.value,
                    page: currentFeedbackPage,
                    per_page: itemsPerPage
                };
                
                // API 요청
                fetch(`/api/admin/feedback?${new URLSearchParams(filters)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('서버 응답 오류');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayFeedbackData(data.feedback);
                        renderFeedbackPagination(data.pagination);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        feedbackTable.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center">데이터를 불러오는 중 오류가 발생했습니다.</td>
                            </tr>
                        `;
                    });
            }
            
            // 피드백 데이터 표시 함수
            function displayFeedbackData(feedbackData) {
                if (feedbackData.length === 0) {
                    feedbackTable.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">데이터가 없습니다.</td>
                        </tr>
                    `;
                    return;
                }
                
                let tableContent = '';
                
                feedbackData.forEach(item => {
                    const scoreClass = item.score > 0 ? 'score-positive' : 'score-negative';
                    const scoreText = item.score > 0 ? '<span class="score-positive">좋아요 (+1)</span>' : '<span class="score-negative">싫어요 (-1)</span>';
                    
                    // 진단 정보 처리
                    let diagnosisInfo = '없음';
                    if (item.diagnoses && Array.isArray(item.diagnoses) && item.diagnoses.length > 0) {
                        const topDiagnosis = item.diagnoses[0];
                        if (topDiagnosis && topDiagnosis.diagnosis && topDiagnosis.probability !== undefined) {
                            const diagnosisName = topDiagnosis.diagnosis;
                            const probability = Math.round(topDiagnosis.probability * 100);
                            diagnosisInfo = `${diagnosisName} (${probability}%)`;
                            
                            // 추가 진단이 있는 경우 툴팁 추가
                            if (item.diagnoses.length > 1) {
                                const otherDiagnoses = item.diagnoses.slice(1, 3)  // 상위 3개까지만 표시
                                    .filter(d => d && d.diagnosis)
                                    .map(d => `${d.diagnosis} (${Math.round((d.probability || 0) * 100)}%)`)
                                    .join('<br>');
                                
                                if (otherDiagnoses) {
                                    diagnosisInfo += `
                                        <span class="ms-1" data-bs-toggle="tooltip" data-bs-html="true" 
                                            title="다른 진단:<br>${otherDiagnoses}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                            </svg>
                                        </span>
                                    `;
                                }
                            }
                        }
                    }
                    
                    tableContent += `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input feedback-checkbox" data-id="${item.id}">
                            </td>
                            <td>${item.id}</td>
                            <td>${item.model}</td>
                            <td>
                                <img src="${item.image_path}" class="feedback-image cursor-pointer" 
                                     onerror="this.src='/static/img/no-image.png'; this.onerror=null;" 
                                     alt="이미지"
                                     data-bs-toggle="modal" data-bs-target="#imageModal"
                                     onclick="showImageInModal('${item.image_path}')">
                            </td>
                            <td>${item.ip_address}</td>
                            <td>${scoreText}</td>
                            <td>${diagnosisInfo}</td>
                            <td>${formatDateToKoreanTime(item.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                feedbackTable.innerHTML = tableContent;
                
                // 툴팁 초기화
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            function formatDateToKoreanTime(dateStr) {
                // 서버에서 받은 날짜를 Date 객체로 변환
                const date = new Date(dateStr);

                // UTC 기준 시간에 9시간(32400000 밀리초)를 더해 한국 시간으로 변환
                const koreanTime = new Date(date.getTime() + (18 * 60 * 60 * 1000));

                // 년, 월, 일, 시, 분, 초 추출
                const year = koreanTime.getUTCFullYear();
                const month = koreanTime.getUTCMonth() + 1; // getMonth()는 0부터 시작하므로 1을 더함
                const day = koreanTime.getUTCDate();
                const hours = koreanTime.getUTCHours();
                const minutes = koreanTime.getUTCMinutes();
                const seconds = koreanTime.getUTCSeconds();

                // 한국식 날짜 형식으로 포맷팅 (YYYY. MM. DD. HH:MM:SS)
                return `${year}. ${month.toString().padStart(2, '0')}. ${day.toString().padStart(2, '0')}. ` +
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // 피드백 페이지네이션 렌더링 함수
            function renderFeedbackPagination(pagination) {
                if (pagination.total_pages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                const { current_page, total_pages } = pagination;
                
                let paginationHTML = `
                    <nav>
                        <ul class="pagination">
                `;
                
                // 이전 페이지 버튼
                if (current_page > 1) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${current_page - 1}">이전</a>
                        </li>
                    `;
                } else {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">이전</a>
                        </li>
                    `;
                }
                
                // 페이지 번호
                const startPage = Math.max(1, current_page - 2);
                const endPage = Math.min(total_pages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    if (i === current_page) {
                        paginationHTML += `
                            <li class="page-item active">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>
                        `;
                    } else {
                        paginationHTML += `
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>
                        `;
                    }
                }
                
                // 다음 페이지 버튼
                if (current_page < total_pages) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${current_page + 1}">다음</a>
                        </li>
                    `;
                } else {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">다음</a>
                        </li>
                    `;
                }
                
                paginationHTML += `
                        </ul>
                    </nav>
                `;
                
                paginationContainer.innerHTML = paginationHTML;
                
                // 페이지 클릭 이벤트 추가
                const pageLinks = paginationContainer.querySelectorAll('.page-link');
                pageLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        if (!isNaN(page)) {
                            currentFeedbackPage = page;
                            loadFeedbackData();
                        }
                    });
                });
            }
            
            // 로그 체크박스 상태 업데이트 함수
            function updateLogSelectedState() {
                const checkboxes = document.querySelectorAll('.log-checkbox');
                const selectedCount = document.querySelectorAll('.log-checkbox:checked').length;
                
                // 모두 선택 체크박스 상태 업데이트
                if (checkboxes.length > 0 && selectedCount === checkboxes.length) {
                    logSelectAllCheckbox.checked = true;
                    logSelectAllCheckbox.indeterminate = false;
                } else if (selectedCount > 0) {
                    logSelectAllCheckbox.checked = false;
                    logSelectAllCheckbox.indeterminate = true;
                } else {
                    logSelectAllCheckbox.checked = false;
                    logSelectAllCheckbox.indeterminate = false;
                }
                
                // 삭제 버튼 상태 업데이트
                logDeleteSelectedBtn.disabled = selectedCount === 0;
            }
            
            // 로그 모두 선택 체크박스 이벤트
            logSelectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.log-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                
                updateLogSelectedState();
            });
            
            // 로그 테이블 이벤트 위임 (체크박스 변경 및 삭제 버튼 클릭)
            logTable.addEventListener('change', function(e) {
                if (e.target.classList.contains('log-checkbox')) {
                    updateLogSelectedState();
                }
            });
            
            logTable.addEventListener('click', function(e) {
                if (e.target.closest('.log-delete-btn')) {
                    const button = e.target.closest('.log-delete-btn');
                    const id = button.getAttribute('data-id');
                    
                    if (confirm('정말로 이 분석 로그를 삭제하시겠습니까?')) {
                        deleteLog([id]);
                    }
                }
            });
            
            // 로그 선택 항목 삭제 버튼 이벤트
            logDeleteSelectedBtn.addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('.log-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(checkbox => 
                    checkbox.getAttribute('data-id')
                );
                
                if (selectedIds.length === 0) {
                    alert('삭제할 항목을 선택해주세요.');
                    return;
                }
                
                if (confirm(`선택한 ${selectedIds.length}개 항목을 삭제하시겠습니까?`)) {
                    deleteLog(selectedIds);
                }
            });
            
            // 로그 삭제 함수
            function deleteLog(ids) {
                fetch('/api/admin/analysis-log/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ids: ids })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 응답 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    // 성공 메시지 표시
                    alert(`${ids.length}개 항목이 삭제되었습니다.`);
                    
                    // 데이터 다시 로드
                    loadLogData();
                    loadLogStatistics();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('삭제 중 오류가 발생했습니다.');
                });
            }
            
            // 초기 로그 날짜 설정 (7일 전 ~ 오늘)
            logStartDateInput.valueAsDate = sevenDaysAgo;
            logEndDateInput.valueAsDate = today;
            
            // 로그 필터 적용 클릭 이벤트
            logFilterBtn.addEventListener('click', function() {
                currentLogPage = 1;
                loadLogData();
                loadLogStatistics();
            });
            
            // 탭 변경 이벤트 리스너 - 로그 탭을 처음 선택할 때 데이터 로드
            document.getElementById('log-tab').addEventListener('shown.bs.tab', function (e) {
                // 분석 로그 데이터가 아직 로드되지 않았을 때만 로드
                if (!document.querySelector('#log-table tr')) {
                    loadLogData();
                    loadLogStatistics();
                }
            });
            
            // 로그 통계 데이터 로드 함수
            function loadLogStatistics() {
                // 필터 옵션
                const filters = {
                    start_date: logStartDateInput.value,
                    end_date: logEndDateInput.value,
                    model: logModelSelect.value,
                };
                
                // API 요청
                fetch(`/api/admin/analysis-log/statistics?${new URLSearchParams(filters)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('서버 응답 오류');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 통계 데이터 표시
                        totalLogsEl.textContent = data.total_logs || 0;
                        viLogsEl.textContent = data.model_counts?.vi || 0;
                        swinLogsEl.textContent = data.model_counts?.swin || 0;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // 오류 시 0으로 표시
                        totalLogsEl.textContent = '0';
                        viLogsEl.textContent = '0';
                        swinLogsEl.textContent = '0';
                    });
            }
            
            // 로그 데이터 로드 함수
            function loadLogData() {
                // 필터 옵션
                const filters = {
                    start_date: logStartDateInput.value,
                    end_date: logEndDateInput.value,
                    model: logModelSelect.value,
                    page: currentLogPage,
                    per_page: itemsPerPage
                };
                
                // API 요청
                fetch(`/api/admin/analysis-log?${new URLSearchParams(filters)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('서버 응답 오류');
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayLogData(data.logs);
                        renderLogPagination(data.pagination);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        logTable.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">데이터를 불러오는 중 오류가 발생했습니다.</td>
                            </tr>
                        `;
                    });
            }
            
            // 로그 데이터 표시 함수
            function displayLogData(logData) {
                if (!logData || logData.length === 0) {
                    logTable.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">데이터가 없습니다.</td>
                        </tr>
                    `;
                    return;
                }
                
                let tableContent = '';
                
                logData.forEach(item => {
                    // 진단 정보 처리
                    let diagnosisInfo = '없음';
                    if (item.diagnoses && Array.isArray(item.diagnoses) && item.diagnoses.length > 0) {
                        const topDiagnosis = item.diagnoses[0];
                        if (topDiagnosis && topDiagnosis.diagnosis && topDiagnosis.probability !== undefined) {
                            const diagnosisName = topDiagnosis.diagnosis;
                            const probability = Math.round(topDiagnosis.probability * 100);
                            diagnosisInfo = `${diagnosisName} (${probability}%)`;
                            
                            // 추가 진단이 있는 경우 툴팁 추가
                            if (item.diagnoses.length > 1) {
                                const otherDiagnoses = item.diagnoses.slice(1, 3)  // 상위 3개까지만 표시
                                    .filter(d => d && d.diagnosis)
                                    .map(d => `${d.diagnosis} (${Math.round((d.probability || 0) * 100)}%)`)
                                    .join('<br>');
                                
                                if (otherDiagnoses) {
                                    diagnosisInfo += `
                                        <span class="ms-1" data-bs-toggle="tooltip" data-bs-html="true" 
                                            title="다른 진단:<br>${otherDiagnoses}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                            </svg>
                                        </span>
                                    `;
                                }
                            }
                        }
                    }
                    
                    tableContent += `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input log-checkbox" data-id="${item.id}">
                            </td>
                            <td>${item.id}</td>
                            <td>${item.model}</td>
                            <td>
                                <img src="${item.image_path}" class="feedback-image cursor-pointer" 
                                     onerror="this.src='/static/img/no-image.png'; this.onerror=null;" 
                                     alt="이미지"
                                     data-bs-toggle="modal" data-bs-target="#imageModal"
                                     onclick="showImageInModal('${item.image_path}')">
                            </td>
                            <td>${item.ip_address}</td>
                            <td>${diagnosisInfo}</td>
                            <td>${formatDateToKoreanTime(item.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-danger log-delete-btn" data-id="${item.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                logTable.innerHTML = tableContent;
                
                // 툴팁 초기화
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
            
            // 로그 페이지네이션 렌더링 함수
            function renderLogPagination(pagination) {
                if (pagination.total_pages <= 1) {
                    logPaginationContainer.innerHTML = '';
                    return;
                }
                
                const { current_page, total_pages } = pagination;
                
                let paginationHTML = `
                    <nav>
                        <ul class="pagination">
                `;
                
                // 이전 페이지 버튼
                if (current_page > 1) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${current_page - 1}">이전</a>
                        </li>
                    `;
                } else {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">이전</a>
                        </li>
                    `;
                }
                
                // 페이지 번호
                const startPage = Math.max(1, current_page - 2);
                const endPage = Math.min(total_pages, startPage + 4);
                
                for (let i = startPage; i <= endPage; i++) {
                    if (i === current_page) {
                        paginationHTML += `
                            <li class="page-item active">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>
                        `;
                    } else {
                        paginationHTML += `
                            <li class="page-item">
                                <a class="page-link" href="#" data-page="${i}">${i}</a>
                            </li>
                        `;
                    }
                }
                
                // 다음 페이지 버튼
                if (current_page < total_pages) {
                    paginationHTML += `
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${current_page + 1}">다음</a>
                        </li>
                    `;
                } else {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">다음</a>
                        </li>
                    `;
                }
                
                paginationHTML += `
                        </ul>
                    </nav>
                `;
                
                logPaginationContainer.innerHTML = paginationHTML;
                
                // 페이지 클릭 이벤트 추가
                const pageLinks = logPaginationContainer.querySelectorAll('.page-link');
                pageLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const page = parseInt(this.getAttribute('data-page'));
                        if (!isNaN(page)) {
                            currentLogPage = page;
                            loadLogData();
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>